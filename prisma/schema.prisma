generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum ChatType {
    private
    group
}

enum FriendRequestStatus {
    pending
    accepted
    declined
}

enum MessageType {
    text
    image
    file
}

enum NotificationType {
    friend_request
    message
    system
}

model User {
    id       String   @id @default(uuid())
    username String   @unique
    email    String   @unique
    password String
    avatar   String   @default("https://api.dicebear.com/7.x/avataaars/svg?seed=default")
    status   String   @default("Hey there! I am using WhatsApp.")
    lastSeen DateTime @default(now())
    isOnline Boolean  @default(false)

    // Relations
    sentMessages     Message[] @relation("SentMessages")
    receivedMessages Message[] @relation("ReceivedMessages")

    sentRequests     FriendRequest[] @relation("SentRequests")
    receivedRequests FriendRequest[] @relation("ReceivedRequests")

    blocksInitiated Block[] @relation("BlocksInitiated")
    blocksReceived  Block[] @relation("BlocksReceived")

    notifications Notification[]
    chats         ChatUser[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Chat {
    id   String   @id @default(uuid())
    type ChatType
    name String?

    users    ChatUser[]
    messages Message[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model ChatUser {
    chatId String
    userId String

    chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@id([chatId, userId])
}

model Message {
    id      String      @id @default(uuid())
    content String
    isRead  Boolean     @default(false)
    type    MessageType @default(text)

    senderId   String
    receiverId String?
    chatId     String?

    sender   User  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
    receiver User? @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
    chat     Chat? @relation(fields: [chatId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model FriendRequest {
    id         String              @id @default(uuid())
    senderId   String
    receiverId String
    status     FriendRequestStatus @default(pending)

    sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
    receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([senderId, receiverId])
}

model Block {
    id        String @id @default(uuid())
    blockerId String
    blockedId String

    blocker User @relation("BlocksInitiated", fields: [blockerId], references: [id], onDelete: Cascade)
    blocked User @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([blockerId, blockedId])
}

model Notification {
    id       String           @id @default(uuid())
    userId   String
    type     NotificationType
    title    String
    content  String?
    metaData Json?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    isRead    Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
